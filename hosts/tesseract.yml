---
- name: configure basic elements of Tesseract
  hosts:
    - tesseract
  roles:
    - git_dotfiles_role
    - git_scripts_role
    - linux_role
    - drake_role
  tasks:

  - name: check if the dotfiles are present
    stat:
      path: /home/drake/dotfiles
    register: dotfiles

  # ZED, configure, restart
  - name: check for existing zed.rc
    stat:
      path: /etc/zfs/zed.d/zed.rc
    register: zed_rc

  - name: check for existing zed.rc.bkup
    stat:
      path: /etc/zfs/zed.d/zed.rc.bkup
    register: zed_rc_bkup

  - name: backup zed.rc if the backup doesn't exist
    copy:
      src:  /etc/zfs/zed.d/zed.rc
      dest: /etc/zfs/zed.d/zed.rc.bkup
      remote_src: yes
    when: not zed_rc_bkup.stat.exists

  - name: remove the existing zed.rc
    file:
      path: /etc/zfs/zed.d/zed.rc
      state:  absent
    when: dotfiles.stat.exists and (zed_rc.stat.islnk is defined and zed_rc.stat.islnk == False)

  - name: link zed.rc
    file:
      src:  /home/drake/dotfiles/zed/zed.rc
      dest: /etc/zfs/zed.d/zed.rc
      state:  link
    when: dotfiles.stat.exists and (zed_rc.stat.islnk is defined and zed_rc.stat.islnk == False)

  - name: enable and restart ZED
    systemd:
      name: zed
      state:  restarted
      enabled:  yes

  # sanoid, configure, restart
  # also download
  - name: first sanoid should be installed
    debug:
      msg: https://github.com/jimsalterjrs/sanoid/blob/master/INSTALL.md

  - name: check for existing sanoid.conf
    stat:
      path: /etc/sanoid/sanoid.conf
    register: sanoid_conf

  - name: check for existing sanoid.conf.bkup
    stat:
      path: /etc/sanoid/sanoid.conf.bkup
    register: sanoid_bkup

  - name: backup sanoid.conf if the backup doesn't exist
    copy:
      src:  /etc/sanoid/sanoid.conf
      dest: /etc/sanoid/sanoid.conf.bkup
      remote_src: yes
    when: not sanoid_bkup.stat.exists

  - name: remove the existing sanoid.conf
    file:
      path: /etc/sanoid/sanoid.conf
      state:  absent
    when: dotfiles.stat.exists and (sanoid_conf.stat.islnk is defined and sanoid_conf.stat.islnk == False)

  - name: link sanoid.conf
    file:
      src:  /home/drake/dotfiles/sanoid/sanoid.conf
      dest: /etc/sanoid/sanoid.conf
      state:  link
    when: dotfiles.stat.exists and (sanoid_conf.stat.islnk is defined and sanoid_conf.stat.islnk == False)

  - name: enable and restart sanoid
    systemd:
      name: sanoid
      state:  restarted
      enabled:  yes

  # email setup stuff
